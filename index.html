<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mebel suratini yuborish</title>
<style>
body { font-family: Arial; background: #f1f5f9; display:flex; flex-direction:column; align-items:center; padding:20px; }
.card { background:#fff; padding:20px; border-radius:14px; box-shadow:0 0 10px rgba(0,0,0,0.1); width:100%; max-width:420px; }
video, img { width:100%; border-radius:10px; margin-top:10px; background:black; }
button { background:#0088cc; color:white; border:none; padding:10px; border-radius:8px; margin-top:10px; cursor:pointer; }
select, textarea { width:100%; margin-top:10px; padding:8px; border-radius:8px; border:1px solid #ccc; }
</style>
</head>
<body>
<div class="card">
  <h2>ðŸ“· Mebel suratini yuborish</h2>
  <select id="cameraSelect"></select>
  <video id="camera" autoplay playsinline></video>
  <button onclick="takePhoto(1)">1-rasm olish</button>
  <button onclick="takePhoto(2)">2-rasm olish</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="photo1"><img id="photo2">
  <textarea id="message" placeholder="Sharh yoki narx yozing..."></textarea>
  <button onclick="sendToTelegram()">Telegramga yuborish</button>
  <p id="status"></p>
</div>

<script>
let stream;
let photos = {};

async function initCameras() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(d => d.kind === 'videoinput');
  const select = document.getElementById('cameraSelect');
  select.innerHTML = '';
  videoDevices.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.deviceId;
    opt.text = d.label || `Kamera ${select.length + 1}`;
    select.appendChild(opt);
  });
  select.onchange = startCamera;
  startCamera();
}

async function startCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  const deviceId = document.getElementById('cameraSelect').value;
  stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
  document.getElementById('camera').srcObject = stream;
}

function takePhoto(num) {
  const video = document.getElementById('camera');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const dataUrl = canvas.toDataURL('image/jpeg');
  document.getElementById('photo' + num).src = dataUrl;
  photos['photo' + num] = dataUrl;
}

function dataURLtoBlob(dataURL) {
  const arr = dataURL.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr], { type: mime });
}

async function sendToTelegram() {
  const msg = document.getElementById('message').value.trim();
  const status = document.getElementById('status');
  if (!photos.photo1 || !photos.photo2) {
    status.innerText = 'Avval 2 ta surat oling!';
    status.style.color = 'red';
    return;
  }
  status.innerText = 'Yuborilmoqda...';
  const botToken = '8549302717:AAFIs_62CbYCzErnkvTqbfJPOV2DMPLlmH8';
  const chatId = '-1002111099262';
  for (let i=1; i<=2; i++) {
    const form = new FormData();
    form.append('chat_id', chatId);
    form.append('caption', msg + ` (${i}-rasm)`);
    form.append('photo', dataURLtoBlob(photos['photo'+i]), `photo${i}.jpg`);
    await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, { method:'POST', body: form });
  }
  status.innerText = 'âœ… Yuborildi!';
  status.style.color = 'green';
}

initCameras();
</script>
</body>
</html>
