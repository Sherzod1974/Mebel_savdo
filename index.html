<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mebel suratini yuborish</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f1f5f9;
  color: #222;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}
.card {
  background: white;
  padding: 25px;
  border-radius: 16px;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
  text-align: center;
  width: 100%;
  max-width: 420px;
}
button {
  background: #0088cc;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  transition: 0.3s;
  margin-top: 10px;
}
button:hover { background: #006699; }
#cameraSwitch button { margin: 5px; }
video, img {
  width: 100%;
  border-radius: 10px;
  margin-top: 10px;
  background: black;
}
textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 16px;
  margin-top: 10px;
}
</style>
</head>
<body>
  <div class="card">
    <h2>üì∑ Mebel suratini yuborish</h2>
    <div id="cameraSwitch">
      <button onclick="startCamera('user')">Old kamera</button>
      <button onclick="startCamera('environment')">Orqa kamera</button>
    </div>
    <video id="camera" autoplay playsinline></video>
    <button onclick="takePhoto(1)">1-rasm olish</button>
    <button onclick="takePhoto(2)">2-rasm olish</button>
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="photo1" alt="1-rasm yo‚Äòq">
    <img id="photo2" alt="2-rasm yo‚Äòq">
    <textarea id="message" placeholder="Sharh yoki narxni kiriting..."></textarea>
    <button onclick="sendToTelegram()">Telegramga yuborish</button>
    <p id="status"></p>
  </div>

<script>
let stream;
let photos = {};

async function startCamera(mode) {
  try {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: mode }
    });
    document.getElementById('camera').srcObject = stream;
  } catch (e) {
    alert("Kamera ishga tushmadi: " + e.message);
  }
}

function takePhoto(num) {
  const video = document.getElementById('camera');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  const dataUrl = canvas.toDataURL('image/jpeg');
  document.getElementById('photo' + num).src = dataUrl;
  photos['photo' + num] = dataUrl;
}

function dataURLtoBlob(dataURL) {
  const arr = dataURL.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr], { type: mime });
}

async function sendToTelegram() {
  const msg = document.getElementById('message').value.trim();
  const status = document.getElementById('status');
  if (!photos.photo1 || !photos.photo2) {
    status.innerText = 'Iltimos, 2 ta surat oling.';
    status.style.color = 'red';
    return;
  }

  status.innerText = '‚è≥ Yuborilmoqda...';
  status.style.color = '#444';

  const botToken = '8549302717:AAFIs_62CbYCzErnkvTqbfJPOV2DMPLlmH8';
  const chatId = '-1002111099262';

  try {
    for (let i = 1; i <= 2; i++) {
      const form = new FormData();
      form.append('chat_id', chatId);
      form.append('caption', msg + ` (${i}-rasm)`);
      form.append('photo', dataURLtoBlob(photos['photo' + i]), `photo${i}.jpg`);
      await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
        method: 'POST',
        body: form
      });
    }

    status.innerText = '2 ta surat va xabar yuborildi!';
    status.style.color = 'green';
    document.getElementById('message').value = '';
  } catch (err) {
    status.innerText = 'Internet ulanmagan yoki API ishlamayapti.';
    status.style.color = 'red';
  }
}
</script>
</body>
</html>
